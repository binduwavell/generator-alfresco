# AMP Management

See (http://docs.alfresco.com/5.0/tasks/alfresco-sdk-advanced-add-custom-amps-aio.html)
for general documentation on adding new AMPs to SDK AIO projects. Here are the specific
steps that are used with the generator-alfresco for managing the AMPS within the project.

## Creating an Alfresco AMP

A new repo amp can be generated by using the following sub-generator.

```
yo alfresco:amp
```

### Add
```
? Add, Remove, reName? (A/R/N) A
? Would you like to create a repo or share AMP? (use arrow keys)
>repo
 share
? Module groupId?
? Module Id?
? Module version?
```
### Remove

```
? Add, Remove, reName? (A/R/N) R
? Which module would you like to remove? (use arrow keys)
>repo-amp
 share-amp
```
### Rename

```
? Add, Remove, reName? (A/R/N) N
? Which module would you like to rename? (use arrow keys)
>repo-amp
 share-amp

? Module groupId?
? Module Id?
? Module version?
```


### Steps the sub-generator takes when adding a new Alfresco AMP

1. Make sure that amps_source/*AMPName* doesn't exist. Throw error if it does.
2. Create *AMPName* and Copy amps_source_templates/repo-amp/* to amps_source/*AMPName*
3. Rename *AMPName*/src/main/amp/config/alfresco/module/**repo-amp** to 
amps_source/*AMPName*/src/main/amp/config/alfresco/module/**AMPName**
4. Edit /pom.xml to reference new AMP adding *\<module>AMPName\</module>* to \<modules>.
~~~
  <modules>
    <module>AMPName</module>
    <module>repo</module>
    <module>solr-config</module>
    <module>share</module>
    <module>runner</module>
  </modules>
~~~
5. Edit amps_source/*AMPName*/pom.xml
   1. Update the \<artifactId>, \<name>, and \<description> elements with the new AMPName.
    ~~~
    <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
       <modelVersion>4.0.0</modelVersion>
       <artifactId>AMPName</artifactId>
       <name>AMPName</name>
       ...
       <description>AMPName</description>
    ~~~
6. Edit repo/pom.xml
   1. Edit the \<dependencies> and add the new module dependency
   ~~~
      <dependencies>
      ...
         <dependency>
           <groupId>${project.groupId}</groupId>
           <artifactId>AMPName</artifactId>
           <version>${project.version}</version>
           <type>amp</type>
         </dependency>
      ...
   ~~~
   2. Edit the \<overlays> and add the new overlay
   ~~~
      <overlays>
         <!-- Current project customizations. This is normally empty, since customizations come from the AMPs -->
         <overlay/>
         <!-- The Alfresco WAR -->
         <overlay>
             <groupId>${alfresco.groupId}</groupId>
             <artifactId>${alfresco.repo.artifactId}</artifactId>
             <type>war</type>
             <!-- To allow inclusion of META-INF -->
             <excludes/>
         </overlay>
         
         <!-- Add / sort your AMPs here -->
         <overlay>
             <groupId>${project.groupId}</groupId>
             <artifactId>AMPName</artifactId>
             <type>amp</type>
         </overlay>
   ~~~
7. Edit runner/tomcat/context-repo.xml
   1. Edit the \<Resources> element and update the extraResourcePaths attribute adding your target web folder   
   ~~~
      <Context docBase="${project.parent.basedir}/alfresco-war/target/${project.build.finalName}">
         <!-- Pick up static resource files from AMPs and other directories (this should not include docBase) -->
         <Resources className="org.apache.naming.resources.VirtualDirContext"
               extraResourcePaths="/=${project.parent.basedir}/AMPName/target/AMPName/web" />   
   ~~~
   
   If there is already another resource path to an amp target \(e.g. OtherAMPName) add yours to the end with a comma seperator.
   ~~~
      <Context docBase="${project.parent.basedir}/alfresco-war/target/${project.build.finalName}">
         <!-- Pick up static resource files from AMPs and other directories (this should not include docBase) -->
         <Resources className="org.apache.naming.resources.VirtualDirContext"
               extraResourcePaths="/=${project.parent.basedir}/OtherAMPName/target/OtherAMPName/web,
                                   /=${project.parent.basedir}/AMPName/target/AMPName/web" />   
   ~~~
   2. Edit the \<Loader> element and the virtualClassPath attribute and point it to the classes, config, and test-classes folders
   for your AMPName.
   ~~~
    <!-- Setup the virtual class path like this:
         1) target/classes
         2) target/${project.build.finalName}/config
         3) target/test-classes

         This way mvn compile can be invoked and all changes will be picked up
    -->
    <Loader className="org.apache.catalina.loader.VirtualWebappLoader"
            searchVirtualFirst="true"
            virtualClasspath="${project.parent.basedir}/AMPName/target/classes;
                              ${project.parent.basedir}/AMPName/target/AMPName/config;
                              ${project.parent.basedir}/AMPName/target/test-classes;${project.parent.basedir}/AMPName/target/classes" />
   ~~~
   
   If there is already other paths there say to an amp target \(e.g. OtherAMPName) add yours to the end with a semicolon seperator.
   ~~~
    <!-- Setup the virtual class path like this:
         1) target/classes
         2) target/${project.build.finalName}/config
         3) target/test-classes

         This way mvn compile can be invoked and all changes will be picked up
    -->
    <Loader className="org.apache.catalina.loader.VirtualWebappLoader"
            searchVirtualFirst="true"
            virtualClasspath="${project.parent.basedir}/OtherAMPName/target/classes;
                              ${project.parent.basedir}/OtherAMPName/target/OtherAMPName/config;
                              ${project.parent.basedir}/OtherAMPName/target/test-classes;${project.parent.basedir}/OtherAMPName/target/classes;
                              ${project.parent.basedir}/AMPName/target/classes;
                              ${project.parent.basedir}/AMPName/target/AMPName/config;
                              ${project.parent.basedir}/AMPName/target/test-classes;${project.parent.basedir}/AMPName/target/classes" />
   ~~~


# TODO
* currently the top level generator removes samples before it makes copies for the template. Should it do that? Do we
want to have an option to add/remove samples?
* need to add an update for functional-testing for runner/pom.xml
8. Edit runner/pom.xml
   1. Update the maven-failsafe-plugin in the functional-testing profile to specify the functional tests for
   the new AMP. The 2.x SDK puts the \<configuration\> block above the \<execution\> blocks for testing, thus you
   can only specify a single share AMP test in here. It should be moved more appropriately.

